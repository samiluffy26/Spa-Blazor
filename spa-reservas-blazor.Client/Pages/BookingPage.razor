@page "/booking"
@using spa_reservas_blazor.Shared.Entities
@using spa_reservas_blazor.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IBookingService BookingService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveAuto

<PageTitle>Reservar Cita - RelaxSpa</PageTitle>

<div class="min-h-screen bg-sage-50 py-12">
    <div class="container-custom max-w-4xl">
        
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 mb-4">
                Reserva tu Momento
            </h1>
            <p class="text-gray-600">
                Completa los siguientes pasos para agendar tu cita
            </p>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="grid md:grid-cols-3 min-h-[600px]">
                
                @* Sidebar - Resumen *@
                <div class="bg-sage-900 text-white p-8 md:col-span-1">
                    <h2 class="font-serif text-xl font-bold mb-6">Tu Reserva</h2>
                    
                    <div class="space-y-6">
                        @* Servicio Seleccionado *@
                        <div class="pb-6 border-b border-sage-700">
                            <p class="text-sage-300 text-sm mb-1">Servicio</p>
                             @if (!string.IsNullOrEmpty(BookingService.CurrentBooking.ServiceName))
                            {
                                <p class="font-medium">@BookingService.CurrentBooking.ServiceName</p>
                                <p class="text-sm text-sage-300">@BookingService.CurrentBooking.ServiceDuration min • $@BookingService.CurrentBooking.ServicePrice</p>
                            }
                            else
                            {
                                <p class="text-sage-400 italic">Selecciona un servicio</p>
                            }
                        </div>

                        @* Fecha y Hora *@
                        <div class="pb-6 border-b border-sage-700">
                            <p class="text-sage-300 text-sm mb-1">Fecha y Hora</p>
                            @if (BookingService.CurrentBooking.Date != default)
                            {
                                <p class="font-medium capitalize">@BookingService.CurrentBooking.Date.ToString("dddd, dd MMMM")</p>
                                @if(BookingService.CurrentBooking.Time != default)
                                {
                                     <p class="text-sm text-sage-300">@BookingService.CurrentBooking.Time.ToString("hh:mm tt")</p>
                                }
                                else
                                {
                                     <p class="text-sage-400 italic">Selecciona una hora</p>
                                }
                            }
                            else
                            {
                                <p class="text-sage-400 italic">Selecciona una fecha</p>
                            }
                        </div>

                        @* Total *@
                        <div class="pt-4">
                            <p class="text-sage-300 text-sm mb-1">Total a pagar</p>
                            <p class="text-3xl font-serif font-bold">$@BookingService.CurrentBooking.ServicePrice</p>
                        </div>
                    </div>
                </div>

                @* Content - Steps *@
                <div class="p-8 md:col-span-2">
                    @* Progress Bar *@
                    <div class="flex items-center justify-between mb-8 relative">
                        <div class="absolute left-0 top-1/2 w-full h-0.5 bg-gray-200 -z-10"></div>
                        
                        @for (int i = 1; i <= 3; i++)
                        {
                            <div class="flex flex-col items-center bg-white px-2">
                                <div class="@GetStepClass(i) w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-colors duration-300">
                                    @i
                                </div>
                                <span class="text-xs font-medium text-gray-500 mt-1">
                                    @GetStepLabel(i)
                                </span>
                            </div>
                        }
                    </div>

                    @* Step Content *@
                    <div class="min-h-[400px]">
                        @if (CurrentStep == 1)
                        {
                            @* STEP 1: Servicios *@
                            <h3 class="text-xl font-bold text-gray-900 mb-6">Selecciona un servicio</h3>
                            <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                @foreach (var service in Services)
                                {
                                    <div @onclick="() => SelectService(service)" 
                                         class="p-4 border rounded-xl cursor-pointer transition-all hover:border-primary-500 hover:shadow-md @(BookingService.CurrentBooking.ServiceId == service.Id ? "border-primary-600 bg-primary-50 ring-1 ring-primary-600" : "border-gray-200")">
                                        <div class="flex justify-between items-center mb-1">
                                            <h4 class="font-semibold text-gray-900">@service.Name</h4>
                                            <span class="font-bold text-primary-700">$@service.Price</span>
                                        </div>
                                        <div class="flex justify-between items-center text-sm text-gray-500">
                                            <span>@service.Duration min</span>
                                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">@service.Category</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (CurrentStep == 2)
                        {
                            @* STEP 2: Fecha y Hora *@
                             <h3 class="text-xl font-bold text-gray-900 mb-6">Elige fecha y hora</h3>
                             
                             <div class="grid md:grid-cols-2 gap-6">
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                                     <input type="date" 
                                            value="@(BookingService.CurrentBooking.Date == default ? DateTime.Today.ToString("yyyy-MM-dd") : BookingService.CurrentBooking.Date.ToString("yyyy-MM-dd"))"
                                            min="@DateTime.Today.ToString("yyyy-MM-dd")"
                                            @onchange="OnDateChange"
                                            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" />
                                 </div>

                                 <div>
                                     <label class="block text-sm font-medium text-gray-700 mb-2">Hora</label>
                                     <div class="grid grid-cols-3 gap-2">
                                         @foreach (var time in AvailableTimeSlots)
                                         {
                                             <button type="button"
                                                     disabled="@(!IsTimeAvailable(time))"
                                                     @onclick="() => SelectTime(time)"
                                                     class="text-sm py-2 px-1 rounded-lg border transition-all @(BookingService.CurrentBooking.Time == time ? "bg-primary-600 text-white border-primary-600" : "hover:border-primary-400 bg-white") @(!IsTimeAvailable(time) ? "opacity-50 cursor-not-allowed bg-gray-50 text-gray-400" : "")">
                                                 @time.ToString("hh:mm tt")
                                             </button>
                                         }
                                     </div>
                                 </div>
                             </div>
                        }
                        else if (CurrentStep == 3)
                        {
                            @* STEP 3: Datos Personales *@
                            <h3 class="text-xl font-bold text-gray-900 mb-6">Tus datos</h3>
                            
                            <EditForm Model="BookingService.CurrentBooking" OnValidSubmit="HandleSubmit">
                                @* No usamos DataAnnotationsValidator porque el modelo original no tenía validaciones, las agregamos manual o asumimos simples *@
                                
                                <div class="space-y-4">
                                    <AuthorizeView Context="authContext">
                                        <NotAuthorized>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                                                <InputText class="w-full rounded-xl border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" 
                                                        @bind-Value="BookingService.CurrentBooking.CustomerName" required />
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                                <InputText type="email" class="w-full rounded-xl border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" 
                                                        @bind-Value="BookingService.CurrentBooking.CustomerEmail" required />
                                            </div>
                                        </NotAuthorized>
                                        <Authorized>
                                            <div class="p-4 bg-sage-50 rounded-xl border border-sage-100 mb-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 bg-sage-200 rounded-full flex items-center justify-center text-sage-700 font-bold">
                                                        @(authContext.User.Identity?.Name?[0].ToString().ToUpper() ?? "?")
                                                    </div>
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900">@authContext.User.Identity?.Name</p>
                                                        <p class="text-xs text-gray-500">Reservando como usuario identificado</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </Authorized>
                                    </AuthorizeView>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                        <InputText type="tel" class="w-full rounded-xl border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" 
                                                   @bind-Value="BookingService.CurrentBooking.CustomerPhone" required />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Notas adicionales (opcional)</label>
                                        <InputTextArea class="w-full rounded-xl border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" rows="3"
                                                       @bind-Value="BookingService.CurrentBooking.Notes" />
                                    </div>
                                    
                                    <div class="pt-4 flex gap-4">
                                        <button type="button" @onclick="PrevStep" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                                            Atrás
                                        </button>
                                        <button type="submit" class="flex-1 btn-primary rounded-xl font-medium shadow-lg hover:shadow-xl transition-all">
                                            Confirmar Reserva
                                        </button>
                                    </div>
                                </div>
                            </EditForm>
                        }
                    </div>

                    @* Navigation Buttons (Steps 1 & 2) *@
                    @if (CurrentStep < 3)
                    {
                        <div class="flex justify-between mt-8 pt-6 border-t border-gray-100">
                             @if (CurrentStep > 1)
                            {
                                <button @onclick="PrevStep" class="px-6 py-2 text-gray-600 hover:text-gray-900 font-medium">
                                    Atrás
                                </button>
                            }
                            else
                            {
                                <div></div> 
                            }

                            <button @onclick="NextStep" 
                                    disabled="@(!CanProceed())"
                                    class="px-8 py-3 bg-primary-600 text-white rounded-xl font-medium shadow-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int CurrentStep = 1;
    private List<Service> Services = new();
    private List<TimeOnly> AvailableTimeSlots = new();

    [SupplyParameterFromQuery]
    public string? ServiceId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Cargar servicios desde el servicio centralizado
        Services = await BookingService.GetServicesAsync();

        // Autocompletar datos si el usuario está logueado
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            BookingService.CurrentBooking.CustomerName = user.Identity.Name ?? "";
            // El email suele venir en el claim "email" o "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
            BookingService.CurrentBooking.CustomerEmail = user.FindFirst(c => c.Type == ClaimTypes.Email || c.Type == "email")?.Value ?? "";
        }

        // Si hay un ServiceId en la URL, seleccionarlo
        if (!string.IsNullOrEmpty(ServiceId))
        {
            var selectedService = Services.FirstOrDefault(s => s.Id == ServiceId);
            if (selectedService != null)
            {
                BookingService.SetService(selectedService);
                CurrentStep = 2; // Auto-advance
                StateHasChanged(); 
            }
        }

        // Slots de tiempo ejemplo
        GenerateTimeSlots();

        // Suscribirse a cambios
        BookingService.OnChange += StateHasChanged;
    }

    private void GenerateTimeSlots()
    {
        AvailableTimeSlots.Clear();
        var start = new TimeOnly(9, 0);
        var end = new TimeOnly(18, 0); // Hasta las 6 PM
        
        while (start < end)
        {
            AvailableTimeSlots.Add(start);
            start = start.AddHours(1);
        }
    }

    private string GetStepClass(int step)
    {
        if (step == CurrentStep) return "bg-primary-600 text-white shadow-lg ring-4 ring-primary-100";
        if (step < CurrentStep) return "bg-green-500 text-white";
        return "bg-gray-200 text-gray-500";
    }

    private string GetStepLabel(int step)
    {
        return step switch
        {
            1 => "Servicios",
            2 => "Fecha",
            3 => "Datos",
            _ => ""
        };
    }

    private void SelectService(Service service)
    {
        BookingService.SetService(service);
    }

    private void OnDateChange(ChangeEventArgs e)
    {
        if (DateOnly.TryParse(e.Value?.ToString(), out var date))
        {
            BookingService.SetDate(date);
        }
    }

    private void SelectTime(TimeOnly time)
    {
        BookingService.SetTime(time);
    }

    private bool IsTimeAvailable(TimeOnly time)
    {
        // Validar si la fecha es hoy, que la hora no haya pasado
        if (BookingService.CurrentBooking.Date == DateOnly.FromDateTime(DateTime.Today))
        {
            if (time <= TimeOnly.FromDateTime(DateTime.Now)) return false;
        }

        // Simular validación de disponibilidad con el servicio
        return BookingService.IsTimeSlotAvailable(BookingService.CurrentBooking.Date, time);
    }

    private bool CanProceed()
    {
        return CurrentStep switch
        {
            1 => !string.IsNullOrEmpty(BookingService.CurrentBooking.ServiceId),
            2 => BookingService.CurrentBooking.Date != default && BookingService.CurrentBooking.Time != default,
            _ => false
        };
    }

    private void NextStep()
    {
        if (CanProceed())
        {
            CurrentStep++;
        }
    }

    private void PrevStep()
    {
        if (CurrentStep > 1)
        {
            CurrentStep--;
        }
    }

    private async Task HandleSubmit()
    {
        await BookingService.CreateBookingAsync(BookingService.CurrentBooking);
        Navigation.NavigateTo("my-bookings");
    }

    public void Dispose()
    {
        BookingService.OnChange -= StateHasChanged;
    }
}
