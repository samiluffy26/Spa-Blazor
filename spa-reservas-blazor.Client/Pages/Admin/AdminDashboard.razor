@page "/admin/dashboard"
@layout Layout.AdminLayout
@using Microsoft.AspNetCore.Authorization
@using spa_reservas_blazor.Shared.DTOs
@using spa_reservas_blazor.Services
@inject IBookingService BookingService

@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<AuthorizeView Roles="Admin" Context="authContext">
    <Authorized>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Stats Cards -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
                <div>
                    <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Reservas Hoy</h3>
                    <div class="flex items-baseline gap-2 mt-2">
                        <p class="text-3xl font-bold text-gray-900">@Stats.BookingsToday</p>
                        <p class="text-gray-400 text-sm">/ @Stats.MaxDailyBookings</p>
                    </div>
                </div>
                
                @* Progress Bar *@
                <div class="mt-4">
                    @{
                        var percentage = Stats.MaxDailyBookings > 0 
                            ? (double)Stats.BookingsToday / Stats.MaxDailyBookings * 100 
                            : 0;
                        var barColor = percentage >= 90 ? "bg-red-500" : percentage >= 70 ? "bg-orange-500" : "bg-primary-500";
                    }
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="@barColor h-2 rounded-full transition-all duration-500" style="width: @(Math.Min(100, percentage))%"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-tighter font-semibold">
                        Ocupación: @percentage.ToString("N0")%
                    </p>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-50 flex items-center gap-2 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="text-xs font-medium">@Stats.OpeningTime - @Stats.ClosingTime</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
                <div>
                    <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Próximas Reservas</h3>
                    <p class="text-3xl font-bold text-gray-900 mt-2">@Stats.UpcomingBookings</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-50 flex items-center gap-2 text-primary-600">
                     <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                    <span class="text-xs font-medium">Total confirmadas</span>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center">
                <div class="flex-1">
                    <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Ingresos Mes</h3>
                    <p class="text-3xl font-bold text-gray-900 mt-2">$@Stats.RevenueMonth.ToString("N0")</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Servicios Activos</h3>
                <p class="text-3xl font-bold text-gray-900 mt-2">@Stats.ActiveServices</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Nuevos Clientes</h3>
                <p class="text-3xl font-bold text-gray-900 mt-2">@Stats.NewClientsMonth</p>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Actividad Reciente</h3>
            <p class="text-gray-500">No hay actividad reciente para mostrar.</p>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="flex flex-col items-center justify-center p-12 text-center">
             <h2 class="text-2xl font-bold text-gray-800 mb-2">Acceso Denegado</h2>
             <p class="text-gray-500">No tienes permisos de Administrador.</p>
             <p class="text-xs text-gray-400 mt-2">AuthCheck on Client: @(DateTime.Now)</p>
             <a href="login" class="mt-4 bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700">Ir al Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private DashboardStats Stats = new();

    protected override async Task OnInitializedAsync()
    {
        Stats = await BookingService.GetDashboardStatsAsync();
    }
}
