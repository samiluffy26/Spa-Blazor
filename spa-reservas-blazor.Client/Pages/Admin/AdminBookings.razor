@page "/admin/bookings"
@layout Layout.AdminLayout
@using Microsoft.AspNetCore.Authorization
@using spa_reservas_blazor.Shared.Entities
@using spa_reservas_blazor.Services
@inject IBookingService BookingService

@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<AuthorizeView Roles="Admin">
    <Authorized>
        <div class="mb-6 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Listado de Reservas</h2>
                <p class="text-gray-500">Administra todas las citas de RelaxSpa</p>
            </div>
            <div class="bg-sage-100 text-sage-800 px-4 py-2 rounded-lg font-medium">
                Total: @allBookings.Count
            </div>
        </div>

        @if (isLoading)
        {
            <div class="flex justify-center p-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sage-600"></div>
            </div>
        }
        else if (allBookings.Count == 0)
        {
            <div class="bg-white p-12 rounded-xl border border-gray-100 text-center shadow-sm">
                <div class="text-gray-300 mb-4 text-5xl">ðŸ“…</div>
                <h3 class="text-lg font-medium text-gray-800">No hay reservas registradas</h3>
                <p class="text-gray-500 mt-2">Cuando los clientes agenden citas aparecerÃ¡n aquÃ­.</p>
            </div>
        }
        else
        {
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100">
                                <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Servicio</th>
                                <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Fecha / Hora</th>
                                <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Precio</th>
                                <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Notas</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            @foreach (var booking in allBookings.OrderByDescending(b => b.Date).ThenByDescending(b => b.Time))
                            {
                                <tr class="hover:bg-gray-50/50 transition-colors">
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-gray-900">@booking.CustomerName</div>
                                        <div class="text-xs text-gray-500">@booking.CustomerEmail</div>
                                        <div class="text-xs text-gray-500">@booking.CustomerPhone</div>
                                    </td>
                                    <td class="px-6 py-4 text-gray-700">
                                        @booking.ServiceName
                                    </td>
                                    <td class="px-6 py-4 text-gray-700">
                                        <div>@booking.Date.ToString("dd/MM/yyyy")</div>
                                        <div class="text-xs text-gray-500">@booking.Time.ToString("HH:mm")</div>
                                    </td>
                                    <td class="px-6 py-4 font-semibold text-gray-900">
                                        $@booking.ServicePrice.ToString("N0")
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @GetStatusClass(booking.Status)">
                                            @GetStatusText(booking.Status)
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-xs text-gray-500 max-w-xs truncate" title="@booking.Notes">
                                        @(string.IsNullOrEmpty(booking.Notes) ? "-" : booking.Notes)
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
         <div class="flex flex-col items-center justify-center p-12 text-center">
             <h2 class="text-2xl font-bold text-gray-800 mb-2">Acceso Denegado</h2>
             <p class="text-gray-500">No tienes permisos para ver esta secciÃ³n.</p>
             <a href="login" class="mt-4 bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700">Ir al Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Booking> allBookings = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        isLoading = true;
        try 
        {
            allBookings = await BookingService.GetAllBookingsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStatusClass(BookingStatus status) => status switch
    {
        BookingStatus.Confirmed => "bg-green-100 text-green-800",
        BookingStatus.Pending => "bg-yellow-100 text-yellow-800",
        BookingStatus.Cancelled => "bg-red-100 text-red-800",
        _ => "bg-gray-100 text-gray-800"
    };

    private string GetStatusText(BookingStatus status) => status switch
    {
        BookingStatus.Confirmed => "Confirmada",
        BookingStatus.Pending => "Pendiente",
        BookingStatus.Cancelled => "Cancelada",
        _ => status.ToString()
    };
}
