@page "/admin/categories"
@using spa_reservas_blazor.Shared.Entities
@using spa_reservas_blazor.Services
@inject IBookingService BookingService
@inject NavigationManager Navigation
@layout Layout.AdminLayout
@using Microsoft.AspNetCore.Authorization

@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<AuthorizeView Roles="Admin" Context="authContext">
    <Authorized>

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">Categorías</h2>
    </div>

    @* Formulario Creación *@
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Nueva Categoría</h3>
        <EditForm Model="NewCategory" OnValidSubmit="HandleCreate">
            <div class="flex gap-4">
                <div class="flex-1">
                    <InputText @bind-Value="NewCategory.Name" placeholder="Nombre de categoría" class="w-full rounded-lg border-gray-300 focus:border-primary-500 focus:ring-primary-500" />
                </div>
                 <div class="flex-1">
                    <InputText @bind-Value="NewCategory.Description" placeholder="Descripción (opcional)" class="w-full rounded-lg border-gray-300 focus:border-primary-500 focus:ring-primary-500" />
                </div>
                <button type="submit" class="bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition-colors">
                    Agregar
                </button>
            </div>
        </EditForm>
    </div>

    @* Lista *@
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-gray-600 font-medium">
                <tr>
                    <th class="p-4">Nombre</th>
                    <th class="p-4">Descripción</th>
                    <th class="p-4 text-right">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                @foreach (var category in Categories)
                {
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-medium text-gray-900">@category.Name</td>
                        <td class="p-4 text-gray-500">@category.Description</td>
                        <td class="p-4 text-right">
                            <button @onclick="() => HandleDelete(category.Id)" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </td>
                    </tr>
                }
                @if (!Categories.Any())
                {
                     <tr>
                        <td colspan="3" class="p-8 text-center text-gray-500">No hay categorías registradas.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
    </Authorized>
    <NotAuthorized>
        <div class="flex flex-col items-center justify-center p-12 text-center">
             <h2 class="text-2xl font-bold text-gray-800 mb-2">Acceso Denegado</h2>
             <p class="text-gray-500">No tienes permisos de Administrador.</p>
             <a href="login" class="mt-4 bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700">Ir al Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@inject IJSRuntime JSRuntime

@code {
    private List<Category> Categories = new();
    private Category NewCategory = new();
    private Category editModel = new(); // Added based on HandleValidSubmit

    protected override async Task OnInitializedAsync()
    {
        Categories = await BookingService.GetCategoriesAsync();
    }

    private async Task LoadCategories()
    {
        Categories = await BookingService.GetCategoriesAsync();
    }

    private async Task HandleCreate()
    {
        if (string.IsNullOrWhiteSpace(NewCategory.Name)) return;
        
        await BookingService.CreateCategoryAsync(NewCategory);
        NewCategory = new Category(); // Reset
        await LoadCategories();
    }

    private async Task HandleValidSubmit()
    {
        if (string.IsNullOrEmpty(editModel.Id))
        {
            await BookingService.CreateCategoryAsync(editModel);
        }
        else
        {
            // Update not implemented in BookingService yet? checks
            // await BookingService.UpdateCategoryAsync(editModel);
            // Assuming create for now or check BookingService
        }
        
        // IsModalOpen = false; // This variable is not defined in the original context, commenting out
        Categories = await BookingService.GetCategoriesAsync();
    }

    private async Task HandleDelete(string id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Estás seguro de eliminar esta categoría?"))
        {
             await BookingService.DeleteCategoryAsync(id);
             await LoadCategories();
        }
    }
}
